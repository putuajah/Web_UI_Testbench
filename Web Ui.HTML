<!DOCTYPE html><html><head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Test Bench Control</title>
<style>
body { font-family: Arial; background:#e9ecef; margin:0;}
.container { max-width:420px;margin:30px auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 2px 8px #0001;}
h2 {color:#0aa;}
.label{font-weight:bold;}
input[type=number]{width:70px;}
.btn{padding:10px 18px;background:#0aa;color:#fff;border:none;border-radius:6px;cursor:pointer;margin:4px;}
.btn-red{background:#d33;}
.btn-blue{background:#0277bd;color:#fff;}
.btn-orange{background:#ff6213;color:#fff}
.btn-Orchid{background:#DA70D6;color:#fff}
</style>
</head>
<body>
<div class="container">
<h2>Test Bench Control</h2>
<div>
  <div class="label">Status Mesin: <span id="state"></span></div>
  <div>
    <button class="btn btn-orange" onclick="aksi('A1')">Persiapan Kliring</button>
    <button class="btn btn-orange" onclick="aksi('A2')">Proses Kliring</button>
    <button class="btn" onclick="aksi('B1')">Persiapan Kalibrasi</button>
    <button class="btn" onclick="aksi('B2')">Proses Kalibrasi</button>
    <button class="btn btn-blue" onclick="aksi('S')">Siap Uji</button>
  </div>
</div>
<hr>
<form onsubmit="return kirimData();">
  <div class="label">Set Durasi (detik):</div>
  KLIRING <input id="kliring" type="number" min="1" value="10"><br>
  TUNGGU <input id="tunggu" type="number" min="1" value="5"><br>
  KALIBRASI <input id="kalibrasi" type="number" min="1" value="30"><br>
  STABIL <input id="stabil" type="number" min="1" value="10"><br>
  <button class="btn" type="submit">Simpan</button>
</form>
<hr>
<div>
  <div class="label">Buzzer: <span id="buzzer"></span>
    <button class="btn" onclick="toggleBuzzer()">Toggle</button>
  </div>
</div>
<hr>
<div>
  <div class="label">Wireless: <span id="wireless"></span>
    <button class="btn" onclick="toggleWireless()">Toggle</button>
  </div>
</div>
<hr>
<div>
  <div class="label">Pilih Servo Input Aktif:</div>
  <select id="inputServoSelect">
    <option value="1">Servo 1</option>
    <option value="3">Servo 3</option>
  </select>
  <button class="btn" onclick="setInputServo()">Set</button>
  <div style="margin-top:6px">Aktif: <span id="activeServo"></span></div>
</div>
<hr>
<div>
  <div class="label">Set Sudut Servo:</div>
  S1 CLOSE <input id="s1c" type="number" min="0" max="180">
  S1 OPEN <input id="s1o" type="number" min="0" max="180"><br>
  S2 CLOSE <input id="s2c" type="number" min="0" max="180">
  S2 OPEN <input id="s2o" type="number" min="0" max="180"><br>
  S3 CLOSE <input id="s3c" type="number" min="0" max="180">
  S3 OPEN <input id="s3o" type="number" min="0" max="180"><br>
  <button class="btn" onclick="setServo()">Simpan Servo</button>
</div>
<hr>
<div>
  <div class="label">Test Servo:</div>
  <!-- Web UI updated: explicit Servo1 (S1) buttons (tidak bergantung pada inputServo) -->
  <button class="btn btn-orange" onclick="testServo(1,document.getElementById('s1c').value)">S1 CLOSE</button>
  <button class="btn btn-orange" onclick="testServo(1,document.getElementById('s1o').value)">S1 OPEN</button>
  <button class="btn" onclick="testServo(2,document.getElementById('s2c').value)">S2 CLOSE</button>
  <button class="btn" onclick="testServo(2,document.getElementById('s2o').value)">S2 OPEN</button>
  <button class="btn btn-Orchid" onclick="testServo(3,document.getElementById('s3c').value)">S3 CLOSE</button>
  <button class="btn btn-Orchid" onclick="testServo(3,document.getElementById('s3o').value)">S3 OPEN</button>
  <button class="btn btn-blue" onclick="masukTestServoMenu()">Masuk Pengaturan Test Servo</button>
</div>
<hr>
<div>
  <div class="label">Kecepatan Servo Input (detik):</div>
  CLOSE -> OPEN <input id="inputSpeedClose" type="number" min="0.2" max="5" step="0.1">
  OPEN -> CLOSE <input id="inputSpeedOpen" type="number" min="0.2" max="5" step="0.1">
  <button class="btn" onclick="setInputServoSpeed()">Simpan Kecepatan</button>
</div>
<hr>
<div>
  <div class="label">Reset EEPROM:</div>
  <button class="btn btn-red" onclick="resetEEPROM()">RESET SELURUH DATA</button>
  <button class="btn btn-red" style="background:#555;margin-left:8px" onclick="rebootDevice()">REBOOT DEVICE</button>
</div>
<script>
function ambil() {
  fetch('/info').then(r=>r.json()).then(d=>{
    document.getElementById('state').innerText = d.state;
    document.getElementById('kliring').value = d.KLIRING;
    document.getElementById('tunggu').value = d.TUNGGU;
    document.getElementById('kalibrasi').value = d.KALIBRASI;
    document.getElementById('stabil').value = d.STABIL;
    document.getElementById('buzzer').innerText = d.buzzer ? 'ON':'OFF';
    document.getElementById('wireless').innerText = d.wireless ? 'ON':'OFF';
    document.getElementById('inputServoSelect').value = d.inputServo;
    document.getElementById('activeServo').innerText = d.inputServo == 1 ? 'Servo 1' : 'Servo 3';
    if (d.inputServoSpeedClose !== undefined) document.getElementById('inputSpeedClose').value = d.inputServoSpeedClose;
    if (d.inputServoSpeedOpen !== undefined) document.getElementById('inputSpeedOpen').value = d.inputServoSpeedOpen;
  });
}
function aksi(act) {
  fetch('/state?set='+act).then(ambil);
}
function kirimData() {
  let k=document.getElementById('kliring').value;
  let t=document.getElementById('tunggu').value;
  let ka=document.getElementById('kalibrasi').value;
  let s=document.getElementById('stabil').value;
  fetch(`/set?KLIRING=${k}&TUNGGU=${t}&KALIBRASI=${ka}&STABIL=${s}`).then(ambil);
  return false;
}
function toggleBuzzer() {
  fetch('/buzzer?toggle=1').then(ambil);
}
function toggleWireless() {
  fetch('/wireless?toggle=1').then(ambil);
}
function ambilServo() {
  fetch("/servo").then(r=>r.json()).then(d=>{
    document.getElementById('s1c').value = d.S1_CLOSE;
    document.getElementById('s1o').value = d.S1_OPEN;
    document.getElementById('s2c').value = d.S2_CLOSE;
    document.getElementById('s2o').value = d.S2_OPEN;
    document.getElementById('s3c').value = d.S3_CLOSE;
    document.getElementById('s3o').value = d.S3_OPEN;
  });
}
function setServo() {
  let s1c = document.getElementById('s1c').value;
  let s1o = document.getElementById('s1o').value;
  let s2c = document.getElementById('s2c').value;
  let s2o = document.getElementById('s2o').value;
  let s3c = document.getElementById('s3c').value;
  let s3o = document.getElementById('s3o').value;
  fetch(`/servo?s1c=${s1c}&s1o=${s1o}&s2c=${s2c}&s2o=${s2o}&s3c=${s3c}&s3o=${s3o}`).then(ambilServo);
}
function setInputServo() {
  let val = document.getElementById('inputServoSelect').value;
  fetch(`/inputservo?set=${val}`).then(ambil);
}
function testServo(id, pos) {
  fetch(`/testservo?id=${id}&pos=${pos}`);
}
function setInputServoSpeed() {
  let vc = parseFloat(document.getElementById('inputSpeedClose').value);
  let vo = parseFloat(document.getElementById('inputSpeedOpen').value);
  if (!isNaN(vc)) {
    if (vc < 0.2) vc = 0.2;
    if (vc > 5) vc = 5;
    fetch(`/inputservospeed?setClose=${vc}`);
  }
  if (!isNaN(vo)) {
    if (vo < 0.2) vo = 0.2;
    if (vo > 5) vo = 5;
    fetch(`/inputservospeed?setOpen=${vo}`).then(ambil);
  } else {
    ambil();
  }
}
function resetEEPROM() {
  if(confirm("Yakin reset semua data?")) fetch("/reset").then(()=>{ambil();ambilServo();});
}
function rebootDevice() {
  if(confirm("Yakin ingin me-reboot device sekarang?")) {
    fetch("/reboot").then(()=>{ alert("Perintah reboot dikirim. Perangkat akan melakukan restart."); });
  }
}
function masukTestServoMenu() {
  fetch("/testservomenu")
    .then(r => {
      if (r.status == 200) {
        alert("Masuk menu Test Servo.");
      } else {
        alert("Menu Test Servo hanya bisa diakses saat mesin SIAP UJI.");
      }
    });
}